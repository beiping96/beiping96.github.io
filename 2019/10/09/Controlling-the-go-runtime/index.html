<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Go,Runtime,GopherCon 2019,Performance," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/B_favicon.ico?v=5.0.2" />






<meta name="description" content="GopherCon 2019Patrick Hawley - Controlling the go runtime">
<meta property="og:type" content="article">
<meta property="og:title" content="Controlling the Go Runtime">
<meta property="og:url" content="http://blog.beiping96.com/2019/10/09/Controlling-the-go-runtime/index.html">
<meta property="og:site_name" content="Beiping96&#39;s Blog">
<meta property="og:description" content="GopherCon 2019Patrick Hawley - Controlling the go runtime">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://blog.beiping96.com/images/uses-in-github.png">
<meta property="og:image" content="http://blog.beiping96.com/images/controlling-the-go-runtime.png">
<meta property="article:published_time" content="2019-10-09T13:00:28.000Z">
<meta property="article:modified_time" content="2020-03-06T05:08:09.599Z">
<meta property="article:author" content="duxingrui">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="Runtime">
<meta property="article:tag" content="GopherCon 2019">
<meta property="article:tag" content="Performance">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.beiping96.com/images/uses-in-github.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://blog.beiping96.com/2019/10/09/Controlling-the-go-runtime/"/>


  <!--
<script data-ad-client="ca-pub-7381930582570374" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
-->
  <title> Controlling the Go Runtime | Beiping96's Blog </title>
<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="//schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Beiping96's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Controlling the Go Runtime
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2019-10-09T21:00:28+08:00" content="2019-10-09">
              2019-10-09
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/10/09/Controlling-the-go-runtime/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/09/Controlling-the-go-runtime/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>GopherCon 2019<br>Patrick Hawley - Controlling the go runtime</p>
<a id="more"></a>

<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>æ¦‚è¿°</p>
<p>Sometimes we need to tell the go runtime what to do. This talk explains how to control the runtime, why we should, and describes three new ways to control it better.</p>
<p>æœ¬æ–‡å°†å±•ç¤ºä¸ºä»€ä¹ˆéœ€è¦æ§åˆ¶ä»¥åŠå¦‚ä½•æ§åˆ¶runtimeï¼Œå¹¶è®¨è®ºä¸‰ç§æ›´å¥½çš„æ§åˆ¶runtimeçš„æ–¹æ³•ã€‚</p>
<p><img src="/images/uses-in-github.png" alt=""></p>
<h3 id="What-is-the-Go-runtime"><a href="#What-is-the-Go-runtime" class="headerlink" title="What is the Go runtime?"></a>What is the Go runtime?</h3><p>runtimeåŒ…èƒ½åšä»€ä¹ˆï¼Ÿ</p>
<p>Itâ€™s a library used by Go programs while they are executing. It controls things like:</p>
<ul>
<li>the garbage collector, managing memory</li>
<li>the goroutine scheduler</li>
</ul>
<p>runtimeåŒ…å¯ä»¥ç”¨äºæ§åˆ¶ï¼š</p>
<ul>
<li>åƒåœ¾å›æ”¶ã€å†…å­˜ç®¡ç†ï¼›</li>
<li>Goroutineè°ƒåº¦å™¨ã€‚</li>
</ul>
<p>It is a helpful assistant. It is a Go package (<a href="https://golang.org/pkg/runtime/" target="_blank" rel="noopener">https://golang.org/pkg/runtime/</a>). It is not an interpreter (e.g. Python, Ruby) or full runtime environment such as the Java virtual machine. It is useful for profiling and observing what happens during program execution.</p>
<p>runtimeåŒ…æ—¢ä¸æ˜¯ä¸€ä¸ªè§£é‡Šå™¨ï¼ˆåœ¨Pythonã€Rubyä¸­ï¼‰ä¹Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¿è¡Œæ—¶ï¼ˆJVMï¼‰ã€‚runtimeåŒ…æ˜¯ä¸€ä¸ªå·¥å…·é›†åˆï¼Œå¯ä»¥ç”¨äºç›‘ç£å’Œåˆ†æç³»ç»Ÿè¿è¡ŒçŠ¶æ€ã€‚</p>
<p>Some functions that can be used to control the garbage collector:</p>
<ul>
<li>GC() - start garbage collection now (blocking operation)</li>
<li>KeepAlive(obj) - obj is needed, at least until now</li>
<li>SetFinalizer(obj, f) - call f when obj is no longer needed</li>
</ul>
<p>runtimeåŒ…æœ‰ä»¥ä¸‹å‡½æ•°å¯ç”¨äºæ§åˆ¶åƒåœ¾å›æ”¶ï¼š</p>
<ul>
<li>GC() - ç«‹å³é˜»å¡ï¼Œå¼€å§‹åƒåœ¾å›æ”¶ï¼›</li>
<li>KeepAlive(obj) - objectåœ¨è¯¥å‡½æ•°æ‰§è¡Œå‰ï¼Œä¸ä¼šè¢«é‡Šæ”¾ï¼›</li>
<li>SetFinalizer(obj, f) - åœ¨objecté‡Šæ”¾æ—¶ï¼Œè°ƒç”¨å‡½æ•°fã€‚</li>
</ul>
<p>Some functions that can be used to control the scheduler:</p>
<ul>
<li>GOMAXPROCS(n) - set max simultaneously executing CPUâ€™s</li>
<li>Goexit() - terminate the calling goroutine</li>
<li>Gosched() - yield processor allowing other goroutines to run</li>
<li>LockOSThread()/UnlockOSThread() - wire/unwire goroutine to current OS thread</li>
</ul>
<p>runtimeåŒ…æœ‰ä»¥ä¸‹å‡½æ•°å¯ç”¨äºæ§åˆ¶è°ƒåº¦å™¨ï¼š</p>
<ul>
<li>GOMAXPROCS(n) - è®¾ç½®æœ€å¤§CPUé€»è¾‘æ ¸æ•°ï¼› // better: <a href="https://github.com/uber-go/automaxprocs" target="_blank" rel="noopener">https://github.com/uber-go/automaxprocs</a> </li>
<li>Goexit() - é€€å‡ºå½“å‰Goroutineï¼›</li>
<li>Gosched() - ä¸­æ–­å½“å‰Goroutineï¼Œè®©å‡ºCPUæ‰§è¡Œæƒï¼›</li>
<li>LockOSThread()/UnlockOSThread() - ç»‘å®š/è§£ç»‘ å½“å‰Goroutineä¸å½“å‰ç³»ç»Ÿçº¿ç¨‹ã€‚</li>
</ul>
<p>Some more controls, in package runtime/debug:</p>
<ul>
<li>func FreeOSMemory()</li>
<li>func SetMaxStack(int) int</li>
<li>func SetGCPercent(int32) int32</li>
<li>func SetPanicOnFault(bool) bool</li>
<li>func SetMaxThreads(int) int</li>
</ul>
<p>env vars: GOMAXPROCS (max executing operating system threads), GOGC (turn off garbage collector)</p>
<p>åœ¨ (<a href="https://golang.org/pkg/runtime/debug/" target="_blank" rel="noopener">https://golang.org/pkg/runtime/debug/</a>) åŒ…è¿˜æä¾›äº†ä»¥ä¸‹å‡½æ•°ï¼š</p>
<ul>
<li>func FreeOSMemory() - å¼ºåˆ¶è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå°½å¯èƒ½å¤šçš„å‘ç³»ç»Ÿè¿”è¿˜å†…å­˜ï¼›</li>
<li>func SetMaxStack(int) int - è®¾ç½®å•ä¸ªGoroutineæœ€å¤§å¯å ç”¨æ ˆï¼Œé»˜è®¤åœ¨32ä½ç³»ç»Ÿä¸Šä¸º250MBï¼Œåœ¨64ä½ç³»ç»Ÿä¸Šä¸º1GBï¼›</li>
<li>func SetGCPercent(int32) int32 - è®¾ç½®è§¦å‘åƒåœ¾å›æ”¶çš„é˜ˆå€¼ï¼Œå½“(æ–°è·å¾—çš„å†…å­˜ / ä¸Šæ¬¡GCåä»å ç”¨çš„å†…å­˜ * 100 &gt;= è¯¥é˜ˆå€¼)æ—¶ï¼Œè§¦å‘GCã€‚ é»˜è®¤å€¼ä¸º100ï¼Œå½“è¯¥å€¼ä¸ºè´Ÿæ—¶ï¼Œå°†ç¦ç”¨åƒåœ¾å›æ”¶ï¼›</li>
<li>func SetPanicOnFault(bool) bool - è®¾ç½®å½“å‘ç”ŸPanicæ—¶ï¼Œæ˜¯å¦è§¦å‘mainå´©æºƒï¼Œè¯¥è®¾ç½®åªå¯¹å½“å‰è°ƒç”¨è€…Goroutineæœ‰æ•ˆï¼›</li>
<li>func SetMaxThreads(int) int - è®¾ç½®å½“å‰Goç³»ç»Ÿè¿›ç¨‹æœ€å¤§ç³»ç»Ÿçº¿ç¨‹æ•°ï¼Œè¶…å‡ºåˆ™è§¦å‘å´©æºƒï¼Œé»˜è®¤å€¼ä¸º10000ã€‚</li>
</ul>
<p>ç¯å¢ƒå˜é‡ï¼š GOMAXPROCS (æœ€å¤§å¹¶è¡Œæ•°)ï¼Œ GOGC (åƒåœ¾å›æ”¶ å¼€/å…³)</p>
<p>You can get indirect control of the runtime via context</p>
<p>ctx, cancel := context.WithCancel(ctx)</p>
<p>The above requests that all goroutines with ctx, stop. This is scheduler control</p>
<p>è¿˜å¯ä»¥é€šè¿‡context.Contexté—´æ¥æ§åˆ¶runtimeï¼ˆä¸åšèµ˜è¿°ï¼‰</p>
<p><code>ctx, cancel := context.WithCancel(ctx)</code></p>
<h3 id="So-â€¦-Why-Control-the-Runtime"><a href="#So-â€¦-Why-Control-the-Runtime" class="headerlink" title="So â€¦ Why Control the Runtime?"></a>So â€¦ Why Control the Runtime?</h3><p>æ‰€ä»¥â€¦ä¸ºä»€ä¹ˆè¦æ§åˆ¶è¿è¡Œæ—¶ï¼Ÿ</p>
<p>Performance reasons. Testing and benchmarks.</p>
<p>runtimeåŒ…åœ¨æå‡æ€§èƒ½ã€æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•ä¸­å¾ˆæœ‰å¸®åŠ©ã€‚</p>
<p><code>go test -cpu 1,2,4</code></p>
<p>Jaeger tracing uses runtime control to match container CPU quota changes.</p>
<p>We use Goexit() all the time via <code>t.Fatal(&quot;some test failed&quot;)</code></p>
<p>Gosched() yields processor to allow other goroutines to run. This can be put in a tight loop to make sure the CPU isnâ€™t hogged.</p>
<p>LockOSThread()/UnlockOSThread()</p>
<p>Thread local state is used by some libs eg Cocoa, OpenGL, libSDL.</p>
<p>GC() is useful for testing, improving performance. For example checking the performance of allocating a slice of integers vs a slice of pointers to int. There are garbage collection implications to handling of values vs pointers so runtime directives can be used to benchmark them.</p>
<p>KeepAlive() holds off garbage collection and there are certain situations where it can be used to stop premature cleanup of e.g. file descriptors.</p>
<p>SetFinalizer() as mentioned sets a function to be called when an obj is no longer needed and can be garbage collected. An example was shown which closes an os.File when it goes out of scope.</p>
<p><code>go test -cpu 1,2,4</code></p>
<p>åœ¨æµ‹è¯•ä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>-cpu</code>æ¥æŒ‡å®šCPUæ ¸æ•°ã€‚</p>
<p><code>t.Fatal(&quot;some test failed&quot;)</code></p>
<p>åœ¨æµ‹è¯•ä¸­ï¼ŒFatalå‡½æ•°ä¼šæ‰§è¡ŒGoexit()ã€‚</p>
<p>Gosched()å¯ä»¥è®©å‡ºCPUæ‰§è¡Œæƒï¼Œç¡®ä¿å…¶å®ƒGoroutineä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œè€Œä¸æ˜¯æ‰§è¡Œæƒè¢«å½“å‰Goroutineç‹¬å ã€‚</p>
<p>åœ¨Cocoa, OpenGL, libSDLåº“ä¸­ï¼Œå‡ä½¿ç”¨äº†LockOSThread()/UnlockOSThread()ã€‚</p>
<p>åœ¨æµ‹è¯•ä¸­ä½¿ç”¨GC()ï¼Œå¯ä»¥å¸®å¿™æ¯”è¾ƒç¨‹åºæ€§èƒ½å·®å¼‚ï¼Œä»è€Œä¼˜åŒ–ç¨‹åºæ€§èƒ½ï¼Œæ¯”å¦‚å¯ä»¥é€šè¿‡åŸºå‡†æµ‹è¯•æ¯”è¾ƒå‡ºå›æ”¶ä¸€ä¸ªâ€œæ•´æ•°åˆ‡ç‰‡â€å’Œä¸€ä¸ªâ€œæ•´æ•°æŒ‡é’ˆåˆ‡ç‰‡â€çš„æ€§èƒ½å·®å¼‚ã€‚</p>
<p>KeepAlive()å¯ä»¥ç¡®ä¿æŸèµ„æºä¸ä¼šåœ¨ä½¿ç”¨å‰è¢«é‡Šæ”¾ï¼Œæ¯”å¦‚æ–‡ä»¶å¥æŸ„ã€‚</p>
<p>SetFinalizer()å¯ä»¥ç¡®ä¿æŸèµ„æºè¢«é‡Šæ”¾æ—¶ï¼Œæ‰§è¡ŒæŒ‡å®šçš„å‡½æ•°é’©å­ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> File <span class="keyword">struct</span> &#123; d <span class="keyword">int</span> &#125;</span><br><span class="line">d, err := syscall.Open(<span class="string">"/file/path"</span>, syscall.O_RDONLY, <span class="number">0</span>)</span><br><span class="line"><span class="comment">// ... do something if err != nil ...</span></span><br><span class="line">p := &amp;File&#123;d&#125;</span><br><span class="line">runtime.SetFinalizer(p, <span class="function"><span class="keyword">func</span><span class="params">(p *File)</span></span> &#123; syscall.Close(p.d) &#125;)</span><br><span class="line"><span class="keyword">var</span> buf [<span class="number">10</span>]<span class="keyword">byte</span></span><br><span class="line">n, err := syscall.Read(p.d, buf[:])</span><br><span class="line"><span class="comment">// Ensure p is not finalized until Read returns.</span></span><br><span class="line">runtime.KeepAlive(p)</span><br><span class="line"><span class="comment">// No more uses of p after this point.</span></span><br></pre></td></tr></table></figure>

<h3 id="Other-Uses-For-Go-Runtime"><a href="#Other-Uses-For-Go-Runtime" class="headerlink" title="Other Uses For Go Runtime"></a>Other Uses For Go Runtime</h3><p>runtimeåŒ…è¿˜å¯ä»¥è¿™æ ·ç”¨</p>
<p>Not just performance! Testing, Correctness, Profiling</p>
<p>So now that we are convinced that using the Go runtime is good!</p>
<p>ä¸ä»…ä»…åœ¨æµ‹è¯•å’Œæ€§èƒ½åˆ†æï¼ŒruntimeåŒ…ä¹Ÿå¯ä»¥åœ¨ç¨‹åºå‡†ç¡®æ€§åˆ¤æ–­å’Œç¨‹åºçŠ¶æ€åˆ†æä¸Šæä¾›å¸®åŠ©ã€‚<br>So æ„‰å¿«åœ°ä½¿ç”¨runtimeåŒ…å§ï¼</p>
<h3 id="New-Ways-to-Control-the-Runtime"><a href="#New-Ways-to-Control-the-Runtime" class="headerlink" title="New Ways to Control the Runtime"></a>New Ways to Control the Runtime</h3><p>æ›´å¥½çš„æ§åˆ¶runtimeçš„æ–¹æ³•</p>
<p>These are a thought experiment, they do NOT exist (yet)!</p>
<p>ä»¥ä¸‹æ˜¯è„‘æ´ç¯èŠ‚ï¼Œå‡æœªå®ç°ï¼</p>
<p>Used the analogy of a â€œcolorâ€ to describe goroutines of a related type</p>
<p><img src="/images/controlling-the-go-runtime.png" alt=""></p>
<p>goroutineID - æè¿°ä¸€ä¸ªgoroutineçš„å”¯ä¸€æ ‡è¯†ï¼Œç‰¹æŒ‡ä¸€ä¸ªgoroutine<br>goroutineColor - æè¿°ä¸€ç±»goroutinesï¼Œthe kind of goroutines</p>
<p><strong>Patrick è®¤ä¸ºåº”è¯¥ä½¿ç”¨coloræè¿°goroutinesï¼Œåº”å…³æ³¨äºgoroutinesçš„åŠŸèƒ½å’Œç›®çš„ï¼Œè€Œä¸æ˜¯goroutineæœ¬èº«ã€‚</strong></p>
<p>GoSchedNext(goroutineColor) - Instruct runtime what to run next. Not by goroutine ids, but goroutines of a certain type. </p>
<p>GoSchedNext(goroutineColor) - å¼€å§‹è°ƒåº¦ä¸€ç±»Goroutinesã€‚</p>
<p>GoAffinity() - requires or suggests that all goroutines of a certain â€œcolorâ€ execute on the same CPU.</p>
<p>Reason:</p>
<ul>
<li>avoid CPU L1/L2 cache misses</li>
<li>NUMA architecture</li>
<li>isolation, keeping code of a certain type separate from other types (e.g. math operations vs http)</li>
</ul>
<p>GoCancel() - cancel all goroutines of a particular â€œcolorâ€<br>GoSend() - Communicate with goroutines of a particular â€œcolorâ€</p>
<p>GoAffinity() - å°†æŸä¸€ç±»Goroutinesç»‘å®šåœ¨åŒä¸€ä¸ªCPUæ ¸ä¸Šã€‚</p>
<p>å°†æŸä¸€ç±»Goroutinesç»‘å®šåœ¨åŒä¸€ä¸ªCPUæ ¸ä¸Šçš„ä¼˜åŠ¿ï¼š</p>
<ul>
<li>æœ‰æ•ˆæé«˜CPU L1/L2 ç¼“å­˜å‘½ä¸­ç‡</li>
<li>é€‚é…NUMAæ¶æ„ <a href="https://en.wikipedia.org/wiki/Non-uniform_memory_access" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Non-uniform_memory_access</a></li>
<li>isolation éš”ç¦»ï¼Œå°†ä¸åŒç±»å‹çš„ç¨‹åºéš”ç¦»å¼€ï¼Œæ¯”å¦‚å¯†é›†è¿ç®—å‹å’Œå¯†é›†IOå‹ã€‚</li>
</ul>
<p>GoCancel() - å–æ¶ˆ/å…³é—­ æŸä¸€ç±»Goroutines<br>GoSend() - å‘æŸä¸€ç±»Goroutineså‘é€Msg ï¼ˆCSP/Actoræ¨¡å‹ï¼‰</p>
<h3 id="Why-is-there-no-goroutine-ID"><a href="#Why-is-there-no-goroutine-ID" class="headerlink" title="Why is there no goroutine ID?"></a>Why is there no goroutine ID?</h3><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡æœ‰GoroutineIDï¼Ÿ</p>
<p><a href="https://golang.org/doc/faq#no_goroutine_id" target="_blank" rel="noopener">https://golang.org/doc/faq#no_goroutine_id</a></p>
<p>è™½ç„¶ä½ è¯´äº†å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯æƒ³è¦ ğŸ¤£ </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">32</span>)</span><br><span class="line">	runtime.Stack(buf[:], <span class="literal">false</span>)</span><br><span class="line">	offset := <span class="built_in">len</span>(<span class="string">"goroutine "</span>)</span><br><span class="line">	bytesGoID := []<span class="keyword">byte</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, r := <span class="keyword">range</span> buf[offset:] &#123;</span><br><span class="line">		<span class="keyword">if</span> r &lt; <span class="string">'0'</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> r &gt; <span class="string">'9'</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		bytesGoID = <span class="built_in">append</span>(bytesGoID, r)</span><br><span class="line">	&#125;</span><br><span class="line">	goID := <span class="keyword">string</span>(bytesGoID)</span><br><span class="line">	fmt.Println(goID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Go/" rel="tag">#Go</a>
          
            <a href="/tags/Runtime/" rel="tag">#Runtime</a>
          
            <a href="/tags/GopherCon-2019/" rel="tag">#GopherCon 2019</a>
          
            <a href="/tags/Performance/" rel="tag">#Performance</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/01/Go-Is-the-encoding-json-Package-Really-Slow/" rel="next" title="Go: Is the encoding/json Package Really Slow?">
                <i class="fa fa-chevron-left"></i> Go: Is the encoding/json Package Really Slow?
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/09/I-wrote-Gocache-a-complete-and-extensible-Go-cache-library/" rel="prev" title="I wrote Gocache: a complete and extensible Go cache library">
                I wrote Gocache: a complete and extensible Go cache library <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>

          <!-- ad start -->
          <!--
<script data-ad-client="ca-pub-7381930582570374" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
-->
          <!-- ad end -->

          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/beiping96.png"
               alt="duxingrui" />
          <p class="site-author-name" itemprop="name">duxingrui</p>
          <p class="site-description motion-element" itemprop="description">beiping96@gmail.com</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">46</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-the-Go-runtime"><span class="nav-number">2.</span> <span class="nav-text">What is the Go runtime?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#So-â€¦-Why-Control-the-Runtime"><span class="nav-number">3.</span> <span class="nav-text">So â€¦ Why Control the Runtime?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Other-Uses-For-Go-Runtime"><span class="nav-number">4.</span> <span class="nav-text">Other Uses For Go Runtime</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#New-Ways-to-Control-the-Runtime"><span class="nav-number">5.</span> <span class="nav-text">New Ways to Control the Runtime</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Why-is-there-no-goroutine-ID"><span class="nav-number">6.</span> <span class="nav-text">Why is there no goroutine ID?</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" style="text-align:center">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">Total <span id="busuanzi_value_site_pv"></span> views,</span>
  <span id="busuanzi_container_page_pv">this page <span id="busuanzi_value_page_pv"></span> hits.</span>
  <br/>
  
  &copy;
   2016
   - 
  
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder"><a href="mailto:beiping96@gmail.com">duxingrui</a></span>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-98210842-1', 'auto');
  ga('send', 'pageview');
  </script>

</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'http-blog-beiping96-com';
      var disqus_identifier = '2019/10/09/Controlling-the-go-runtime/';
      var disqus_title = "Controlling the Go Runtime";
      var disqus_url = 'http://blog.beiping96.com/2019/10/09/Controlling-the-go-runtime/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      
    </script>
  




  
  

  

  

  

  


<!--
  <script type="text/javascript" color="0,0,0" opacity='0.33' zIndex="-1" count="66" src="/js/src/canvas-nest.min.js"></script>
-->

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/Epsilon2.1.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
